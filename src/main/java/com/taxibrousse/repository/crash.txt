// ==========================
// REPOSITORIES (fichiers séparés)
// ==========================

// VoyageRepository.java
package com.taxibrousse.repository;

import com.taxibrousse.entity.Voyage;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.List;

@Repository
public interface VoyageRepository extends JpaRepository<Voyage, Long> {
    List<Voyage> findByDateHeureBetween(LocalDateTime start, LocalDateTime end);
    List<Voyage> findByTrajet_Depart_Id(Long departId);
    List<Voyage> findByTrajet_Arrive_Id(Long arriveId);
    List<Voyage> findByTrajet_Depart_IdAndTrajet_Arrive_Id(Long departId, Long arriveId);
}

// ReservationRepository.java
package com.taxibrousse.repository;

import com.taxibrousse.entity.Reservation;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface ReservationRepository extends JpaRepository<Reservation, Long> {
    List<Reservation> findByVoyage_Id(Long voyageId);
}

// GareRepository.java
package com.taxibrousse.repository;

import com.taxibrousse.entity.Gare;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface GareRepository extends JpaRepository<Gare, Long> {
}

// VoitureRepository.java
package com.taxibrousse.repository;

import com.taxibrousse.entity.Voiture;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface VoitureRepository extends JpaRepository<Voiture, Long> {
}

// StatusRepository.java
package com.taxibrousse.repository;

import com.taxibrousse.entity.Status;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface StatusRepository extends JpaRepository<Status, Long> {
    Status findByLib(String lib);
}

// ==========================
// SERVICES (fichiers séparés)
// ==========================

// VoyageService.java
package com.taxibrousse.service;

import com.taxibrousse.entity.Reservation;
import com.taxibrousse.entity.Voyage;
import com.taxibrousse.repository.ReservationRepository;
import com.taxibrousse.repository.VoyageRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;

@Service
public class VoyageService {

    @Autowired
    private VoyageRepository voyageRepository;

    @Autowired
    private ReservationRepository reservationRepository;

    public List<Voyage> getVoyages(LocalDate date, Long departId, Long arriveId) {
        if (date != null) {
            LocalDateTime start = date.atStartOfDay();
            LocalDateTime end = date.atTime(23, 59, 59);
            return voyageRepository.findByDateHeureBetween(start, end);
        }
        if (departId != null && arriveId != null)
            return voyageRepository.findByTrajet_Depart_IdAndTrajet_Arrive_Id(departId, arriveId);
        if (departId != null)
            return voyageRepository.findByTrajet_Depart_Id(departId);
        if (arriveId != null)
            return voyageRepository.findByTrajet_Arrive_Id(arriveId);
        return voyageRepository.findAll();
    }

    public int getPlacesRestantes(Voyage voyage) {
        int reservees = reservationRepository.findByVoyage_Id(voyage.getId())
                .stream()
                .mapToInt(Reservation::getNbPlaces)
                .sum();
        return voyage.getVoiture().getCapacite() - reservees;
    }
}

// ReservationService.java
package com.taxibrousse.service;

import com.taxibrousse.entity.Reservation;
import com.taxibrousse.entity.Status;
import com.taxibrousse.entity.Voyage;
import com.taxibrousse.repository.ReservationRepository;
import com.taxibrousse.repository.StatusRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class ReservationService {

    @Autowired
    private ReservationRepository reservationRepository;

    @Autowired
    private StatusRepository statusRepository;

    public void reserver(Voyage voyage, String nomClient, int nbPlaces) {
        Status status = statusRepository.findByLib("RESERVE");

        Reservation reservation = new Reservation();
        reservation.setVoyage(voyage);
        reservation.setNomClient(nomClient);
        reservation.setNbPlaces(nbPlaces);
        reservation.setStatus(status);

        reservationRepository.save(reservation);
    }
}

// ==========================
// CONTROLLERS (fichiers séparés)
// ==========================

// AccueilController.java
package com.taxibrousse.controller;

import com.taxibrousse.service.VoyageService;
import com.taxibrousse.repository.GareRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.time.LocalDate;

@Controller
public class AccueilController {

    @Autowired
    private VoyageService voyageService;

    @Autowired
    private GareRepository gareRepository;

    @GetMapping("/")
    public String accueil() {
        return "accueil";
    }

    @GetMapping("/voyages")
    public String voyages(@RequestParam(required = false) String date,
                           @RequestParam(required = false) Long depart,
                           @RequestParam(required = false) Long arrive,
                           Model model) {

        LocalDate d = (date != null && !date.isEmpty()) ? LocalDate.parse(date) : null;

        model.addAttribute("voyages", voyageService.getVoyages(d, depart, arrive));
        model.addAttribute("gares", gareRepository.findAll());
        model.addAttribute("voyageService", voyageService);
        return "voyages/liste";
    }
}

// ReservationController.java
package com.taxibrousse.controller;

import com.taxibrousse.entity.Voyage;
import com.taxibrousse.repository.VoyageRepository;
import com.taxibrousse.service.ReservationService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

@Controller
@RequestMapping("/reservation")
public class ReservationController {

    @Autowired
    private ReservationService reservationService;

    @Autowired
    private VoyageRepository voyageRepository;

    @GetMapping("/{id}")
    public String reserverForm(@PathVariable Long id, org.springframework.ui.Model model) {
        model.addAttribute("voyage", voyageRepository.findById(id).orElse(null));
        return "voyages/reserver";
    }

    @PostMapping
    public String reserver(@RequestParam Long voyageId,
                           @RequestParam String nomClient,
                           @RequestParam int nbPlaces,
                           RedirectAttributes redirectAttributes) {

        Voyage voyage = voyageRepository.findById(voyageId).orElse(null);
        if (voyage != null) {
            reservationService.reserver(voyage, nomClient, nbPlaces);
            redirectAttributes.addFlashAttribute(
                    "message",
                    "Merci pour votre confiance, votre réservation a été effectuée avec succès !"
            );
        }
        return "redirect:/";
    }
}
