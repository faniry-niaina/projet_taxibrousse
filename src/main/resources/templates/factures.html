<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Taxi Brousse - Gestion des Factures Publicit√©s</title>
    <link th:href="@{/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
</head>
<body>
<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üìã Gestion des Factures Publicit√©s par Soci√©t√©</h1>
        <div>
            <a th:href="@{/}" class="btn btn-secondary">üè† Accueil</a>
            <a th:href="@{/chiffre-affaire}" class="btn btn-success">üí∞ Chiffre d'Affaire</a>
            <a th:href="@{/publicites}" class="btn btn-info">üì¢ Publicit√©s</a>
        </div>
    </div>

    <!-- Messages -->
    <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <!-- Pour chaque soci√©t√© -->
    <div th:each="societe : ${societes}" class="card mb-4">
        <!-- En-t√™te de la soci√©t√© -->
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">
                    <span th:text="${societe.lib}"></span>
                    <small class="text-muted ms-3">
                        (Prix unitaire: <span th:text="${#strings.replace(#numbers.formatDecimal(societe.prixUnitairePub, 1, 'POINT', 2, 'COMMA'), ',00', '')}"></span> Ar)
                    </small>
                </h4>
                <div class="mt-1">
                    <span class="badge bg-primary">Total: <span th:text="${#strings.replace(#numbers.formatDecimal(societe.montantTotalPublicites, 1, 'POINT', 2, 'COMMA'), ',00', '')}"></span> Ar</span>
                    <span class="badge bg-success">Pay√©: <span th:text="${#strings.replace(#numbers.formatDecimal(societe.totalPaiements, 1, 'POINT', 2, 'COMMA'), ',00', '')}"></span> Ar (<span th:text="${#strings.replace(#numbers.formatDecimal(societe.pourcentagePaye, 1, 'POINT', 2, 'COMMA'), ',00', '')}"></span>%)</span>
                    <span class="badge" th:classappend="${societe.resteAPayer.compareTo(T(java.math.BigDecimal).ZERO) > 0 ? 'bg-danger' : 'bg-success'}">Reste: <span th:text="${#strings.replace(#numbers.formatDecimal(societe.resteAPayer, 1, 'POINT', 2, 'COMMA'), ',00', '')}"></span> Ar</span>
                </div>
            </div>
            <div>
                <!-- Bouton Voir D√©tails -->
                <a th:href="@{/factures/societe/{id}(id=${societe.id})}" class="btn btn-primary btn-lg me-2">
                    üìÑ Voir D√©tails Facture
                </a>
                <!-- Bouton Ins√©rer Paiement -->
                <button type="button" class="btn btn-success btn-lg" 
                        data-bs-toggle="modal" 
                        th:data-bs-target="'#paiementModal' + ${societe.id}"
                        th:disabled="${societe.resteAPayer.compareTo(T(java.math.BigDecimal).ZERO) <= 0}">
                    üí≥ Ins√©rer Paiement
                </button>
            </div>
        </div>
        
        <!-- Tableau des publicit√©s de cette soci√©t√© -->
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-bordered mb-0">
                    <thead class="table-secondary">
                    <tr>
                        <th>ID Pub</th>
                        <th>Date Pub</th>
                        <th>Voyage (Trajet)</th>
                        <th>V√©hicule</th>
                        <th>Date Voyage</th>
                        <th>Nb Pub</th>
                        <th>Montant Total (Ar)</th>
                        <th class="table-success">Montant Pay√© (Ar)</th>
                        <th class="table-danger">Reste √† Payer (Ar)</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="pub : ${societe.publicites}">
                        <td th:text="${pub.id}"></td>
                        <td th:text="${#temporals.format(pub.date, 'dd/MM/yyyy')}"></td>
                        <td>
                            <span th:text="${pub.voyage.trajet.depart.nom}"></span> ‚Üí 
                            <span th:text="${pub.voyage.trajet.arrive.nom}"></span>
                        </td>
                        <td th:text="${pub.voyage.voiture.matricule}"></td>
                        <td th:text="${#temporals.format(pub.voyage.dateHeure, 'dd/MM/yyyy HH:mm')}"></td>
                        <td class="text-center fw-bold" th:text="${pub.nombre}"></td>
                        <td class="text-end fw-bold text-primary" th:text="${#strings.replace(#numbers.formatDecimal(pub.montantTotal, 1, 'POINT', 2, 'COMMA'), ',00', '')}"></td>
                        <td class="text-end fw-bold text-success table-success" th:text="${#strings.replace(#numbers.formatDecimal(pub.montantPaye, 1, 'POINT', 2, 'COMMA'), ',00', '')}"></td>
                        <td class="text-end fw-bold table-danger" 
                            th:text="${#strings.replace(#numbers.formatDecimal(pub.resteAPayer, 1, 'POINT', 2, 'COMMA'), ',00', '')}"
                            th:classappend="${pub.resteAPayer.compareTo(T(java.math.BigDecimal).ZERO) > 0 ? 'text-danger' : 'text-success'}">
                        </td>
                    </tr>
                    <!-- Ligne vide si pas de publicit√©s -->
                    <tr th:if="${societe.publicites == null or societe.publicites.isEmpty()}">
                        <td colspan="9" class="text-center text-muted">Aucune publicit√© pour cette soci√©t√©</td>
                    </tr>
                    </tbody>
                    <!-- Total pour cette soci√©t√© -->
                    <tfoot class="table-warning" th:if="${societe.publicites != null and !societe.publicites.isEmpty()}">
                    <tr>
                        <td colspan="6" class="text-end fw-bold">TOTAL :</td>
                        <td class="text-end fw-bold text-primary" th:text="${#strings.replace(#numbers.formatDecimal(societe.montantTotalPublicites, 1, 'POINT', 2, 'COMMA'), ',00', '')}"></td>
                        <td class="text-end fw-bold text-success" th:text="${#strings.replace(#numbers.formatDecimal(societe.totalPaiements, 1, 'POINT', 2, 'COMMA'), ',00', '')}"></td>
                        <td class="text-end fw-bold text-danger" th:text="${#strings.replace(#numbers.formatDecimal(societe.resteAPayer, 1, 'POINT', 2, 'COMMA'), ',00', '')}"></td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Total G√©n√©ral -->
    <div class="card bg-dark text-white">
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-4">
                    <h5>Total Factures</h5>
                    <h3 th:with="totalFactures=${#aggregates.sum(societes.![montantTotalPublicites])}"
                        th:text="${#strings.replace(#numbers.formatDecimal(totalFactures, 1, 'POINT', 2, 'COMMA'), ',00', '')} + ' Ar'" class="text-primary"></h3>
                </div>
                <div class="col-md-4">
                    <h5>Total Pay√©</h5>
                    <h3 th:with="totalPaye=${#aggregates.sum(societes.![totalPaiements])}"
                        th:text="${#strings.replace(#numbers.formatDecimal(totalPaye, 1, 'POINT', 2, 'COMMA'), ',00', '')} + ' Ar'" class="text-success"></h3>
                </div>
                <div class="col-md-4">
                    <h5>Total Reste √† Payer</h5>
                    <h3 th:with="totalReste=${#aggregates.sum(societes.![resteAPayer])}"
                        th:text="${#strings.replace(#numbers.formatDecimal(totalReste, 1, 'POINT', 2, 'COMMA'), ',00', '')} + ' Ar'" class="text-danger"></h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals de paiement pour chaque soci√©t√© -->
    <div th:each="societe : ${societes}">
        <div class="modal fade" th:id="'paiementModal' + ${societe.id}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üí≥ Ins√©rer un paiement - <span th:text="${societe.lib}"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form th:action="@{/factures/paiement}" method="post">
                        <div class="modal-body">
                            <input type="hidden" name="societeId" th:value="${societe.id}">
                            
                            <div class="alert alert-info">
                                <strong>Reste √† payer :</strong> 
                                <span th:text="${#strings.replace(#numbers.formatDecimal(societe.resteAPayer, 1, 'POINT', 2, 'COMMA'), ',00', '')}"></span> Ar
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Date du paiement</label>
                                <input type="date" name="datePaiement" class="form-control" required
                                       th:value="${#temporals.format(T(java.time.LocalDate).now(), 'yyyy-MM-dd')}">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Montant (Ar)</label>
                                <input type="number" name="montant" class="form-control" required 
                                       step="0.01" min="0.01" 
                                       th:max="${societe.resteAPayer}"
                                       placeholder="Montant du paiement">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                            <button type="submit" class="btn btn-success">‚úÖ Enregistrer le paiement</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>

<script th:src="@{/bootstrap/js/bootstrap.bundle.min.js}"></script>
</body>
</html>
